<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Which is better?</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --accent: #2563eb;
      --muted: #1b3240;
      --bg: #0f372a;
      --panel: #178950;
      --text: #ffffff;
      --good-bg: #e7f2ff;
      --bad-bg: #fff0f0;
    }
    body { font-family: Arial, sans-serif; padding: 20px; background: #043414; color: var(--text); }
    h2 { margin-top: 10px; }
    label { display: block; margin: 6px 0 2px; }
    input[type="number"], input[type="file"] { width: 120px; margin-bottom: 8px; }
    button { margin-top: 12px; padding: 8px 14px; }
    #result { margin-top: 18px; font-weight: 600; white-space: pre-wrap; background:#053; padding:12px; border-radius:8px; border:1px solid #e6eef8; }
    #instructions { white-space: pre-wrap; }
    #changelogs { white-space: pre-wrap; }
    #attackspeeds { white-space: pre-wrap; }
    .stats { margin-top: 8px; font-style: italic; color:var(--muted) }
    .nav {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin: 0 auto 12px;
      padding: 8px 0;
    }
    .card, .carde{
      background: var(--panel);
      border: 1px solid #dff6e6;
      border-radius: 10px;
      padding: 12px;
      text-decoration: none;
      text-align: center;
      color: var(--text);
      font-weight: 600;
      transition: transform 0.2s, background 0.2s;
    }
    .card:hover {
      background: var(--accent);
      color: #082316;
      transform: translateY(-4px);
    }
    .toggle { display:inline-flex; border-radius:8px; background: #1e623f; padding: 4px; gap:4px; }
    .toggle button{
      border: none;
      background: transparent;
      padding: 0.45rem 0.9rem;
      border-radius:6px;
      cursor: pointer;
      font-weight:600;
      color: #0f172a;
    }
    .toggle button[aria-pressed="true"]{ background: var(--accent); color: #fff; }
    .output { margin-top:8px; font-size:0.95rem; color:var(--muted); }
    .better { background: var(--good-bg); border: 1px solid #0f360f; border-radius:8px; padding:6px; }
    .worse { background: var(--bad-bg); border: 1px solid #ffdede; border-radius:8px; padding:6px; }
    .hidden { display: none !important; }
    .small-note { font-size:0.9rem; color:var(--muted); margin-top:8px; }
    .grid-row { display:flex; gap:24px; flex-wrap:wrap; align-items:flex-start; }
    .column { min-width:200px; }
  </style>
</head>

<body>
  <h1>‚ÅâÔ∏è Which is better?</h1>
  <h2 style="font-weight:normal">Help decide what to keep ‚Äî Kayzee Edit</h2>

  <div style="margin-top:12px;">
    <button onclick="instruct()">Show/Hide Instructions</button>
    <div id="instructions">Instructions will appear here.</div>
  </div>

  <div style="margin-top:12px;">
    <button onclick="changelog()">Show/hide Changelogs</button>
    <div id="changelogs">Changelogs will appear here.</div>
  </div>

  <div style="margin-top:12px;">
    <button onclick="attackspeed()">Show/hide Attack Speed Table</button>
    <div id="attackspeeds">Attack speed summary will appear here.</div>
  </div>

  <h3>üìÅ Upload or Download Player Stats</h3>
  <input type="file" id="uploadJson" accept=".json" onchange="loadJson(this)" />
  <button onclick="downloadSample()">Download Sample Data</button>

  <div class="nav" aria-hidden="false">
    <div class="carde" role="region" aria-label="Preferred substats">
      <div style="font-size:0.95rem">Preferred Substats:</div>
      <div class="toggle" role="tablist" aria-label="Preferred substats">
        <button class="toggle-btn1" data-value="yes" aria-pressed="true">Yes</button>
        <button class="toggle-btn1" data-value="no" aria-pressed="false">No</button>
      </div>
      <input type="hidden" id="yesno-value1" name="yesno1" value="yes">
      <div class="output" id="output1">Selected: Yes</div>
    </div>

    <div class="carde" role="region" aria-label="Double substats">
      <div style="font-size:0.95rem">Double Substats</div>
      <div class="toggle" role="tablist" aria-label="Double substats">
        <button class="toggle-btn2" data-value="yes" aria-pressed="true">Yes</button>
        <button class="toggle-btn2" data-value="no" aria-pressed="false">No</button>
      </div>
      <input type="hidden" id="yesno-value2" name="yesno2" value="yes">
      <div class="output" id="output2">Selected: Yes</div>
    </div>

    <div class="carde" role="region" aria-label="Items only">
      <div style="font-size:0.95rem">Items only</div>
      <div class="toggle" role="tablist" aria-label="Items only">
        <button class="toggle-btn3" data-value="yes" aria-pressed="true">Yes</button>
        <button class="toggle-btn3" data-value="no" aria-pressed="false">No</button>
      </div>
      <input type="hidden" id="yesno-value3" name="yesno3" value="yes">
      <div class="output" id="output3">Selected: Yes</div>
    </div>
  </div>

  <div class="grid-row">
    <div class="column" id="sell">
      <h2 style="margin:6px 0">Old Item</h2>
      <div id="e1">
        <label><input type="number" id="e1_damage" value="0"/> Damage</label>
        <label><input type="number" id="e1_health" value="0"/> Health</label>
        <label><input type="number" id="e1_dmult" value="0"/> Damage (%)</label>
        <label><input type="number" id="e1_hmult" value="0"/> Health (%)</label>
        <label><input type="number" id="e1_speed" value="0"/> Attack Speed (%)</label>
        <label><input type="number" id="e1_double" value="0"/> Double Chance (%)</label>
        <label><input type="number" id="e1_crit" value="0"/> Crit Chance (%)</label>
        <label><input type="number" id="e1_critdmg" value="0"/> Crit Damage (%)</label>
        <label><input type="number" id="e1_lifesteal" value="0"/> Lifesteal (%)</label>
        <label><input type="number" id="e1_range" value="0"/> Range (%)</label>
        <label><input type="number" id="e1_regen" value="0"/> Regen (%)</label>
        <label><input type="number" id="e1_block" value="0"/> Block (%)</label>
        <label><input type="number" id="e1_skill" value="0"/> Skill Damage (%)</label>
        <label><input type="number" id="e1_cooldown" value="0"/> Cooldown (%)</label>
      </div>
      <div class="stats" id="e1_stats"></div>
    </div>

    <div class="column" id="equip">
      <h2 style="margin:6px 0">New Item</h2>
      <div id="e2">
        <label><input type="number" id="e2_damage" value="0"/> Damage</label>
        <label><input type="number" id="e2_health" value="0"/> Health</label>
        <label><input type="number" id="e2_dmult" value="0"/> Damage (%)</label>
        <label><input type="number" id="e2_hmult" value="0"/> Health (%)</label>
        <label><input type="number" id="e2_speed" value="0"/> Attack Speed (%)</label>
        <label><input type="number" id="e2_double" value="0"/> Double Chance (%)</label>
        <label><input type="number" id="e2_crit" value="0"/> Crit Chance (%)</label>
        <label><input type="number" id="e2_critdmg" value="0"/> Crit Damage (%)</label>
        <label><input type="number" id="e2_lifesteal" value="0"/> Lifesteal (%)</label>
        <label><input type="number" id="e2_range" value="0"/> Range (%)</label>
        <label><input type="number" id="e2_regen" value="0"/> Regen (%)</label>
        <label><input type="number" id="e2_block" value="0"/> Block (%)</label>
        <label><input type="number" id="e2_skill" value="0"/> Skill Damage (%)</label>
        <label><input type="number" id="e2_cooldown" value="0"/> Cooldown (%)</label>
      </div>
      <div class="stats" id="e2_stats"></div>
    </div>

    <div class="column" id="hide3">
      <h2 style="margin:6px 0">Player</h2>
      <div id="e3">
        <label><input type="number" id="e3_damage" value="0"/> Damage</label>
        <label><input type="number" id="e3_health" value="0"/> Health</label>
        <label><input type="number" id="e3_dmult" value="0"/> Damage (%)</label>
        <label><input type="number" id="e3_hmult" value="0"/> Health (%)</label>
        <label><input type="number" id="e3_speed" value="0"/> Attack Speed (%)</label>
        <label><input type="number" id="e3_double" value="0"/> Double Chance (%)</label>
        <label><input type="number" id="e3_crit" value="0"/> Crit Chance (%)</label>
        <label><input type="number" id="e3_critdmg" value="0"/> Crit Damage (%)</label>
        <label><input type="number" id="e3_lifesteal" value="0"/> Lifesteal (%)</label>
        <label><input type="number" id="e3_range" value="0"/> Range (%)</label>
        <label><input type="number" id="e3_regen" value="0"/> Regen (%)</label>
        <label><input type="number" id="e3_block" value="0"/> Block (%)</label>
        <label><input type="number" id="e3_skill" value="0"/> Skill Damage (%)</label>
        <label><input type="number" id="e3_cooldown" value="0"/> Cooldown (%)</label>
      </div>
      <div class="stats" id="e3_stats"></div>
    </div>

    <div class="column" id="hide4">
      <h2 style="margin:6px 0">Mount</h2>
      <div id="e4">
        <label><input type="number" id="e4_damage" value="0"/> Damage</label>
        <label><input type="number" id="e4_health" value="0"/> Health</label>
        <label><input type="number" id="e4_dmult" value="0"/> Damage (%)</label>
        <label><input type="number" id="e4_hmult" value="0"/> Health (%)</label>
        <label><input type="number" id="e4_speed" value="0"/> Attack Speed (%)</label>
        <label><input type="number" id="e4_double" value="0"/> Double Chance (%)</label>
        <label><input type="number" id="e4_crit" value="0"/> Crit Chance (%)</label>
        <label><input type="number" id="e4_critdmg" value="0"/> Crit Damage (%)</label>
        <label><input type="number" id="e4_lifesteal" value="0"/> Lifesteal (%)</label>
        <label><input type="number" id="e4_range" value="0"/> Range (%)</label>
        <label><input type="number" id="e4_regen" value="0"/> Regen (%)</label>
        <label><input type="number" id="e4_block" value="0"/> Block (%)</label>
        <label><input type="number" id="e4_skill" value="0"/> Skill Damage (%)</label>
        <label><input type="number" id="e4_cooldown" value="0"/> Cooldown (%)</label>
      </div>
      <div class="stats" id="e4_stats"></div>
    </div>
  </div>

  <div style="margin-top:12px;">
    <button onclick="simulate()">Simulate Build</button>
    <div id="result">Results will appear here.</div>
  </div>

  <div class="nav" style="margin-top:20px;">
    <a href="https://octavian-mirica.github.io/fm-tools/" class="card" target="_blank" rel="noopener noreferrer">
      <div class="icon">üêà‚Äç‚¨õ</div>
      <div>Fm Tools by Fitz</div>
    </a>
    <a href="https://victorygale.github.io/fm_tools/" class="card" target="_blank" rel="noopener noreferrer">
      <div class="icon">ñ®Ü</div>
      <div>FM Tools Kayzee Edit</div>
    </a>
  </div>

  <script>
    // Helpers
    const $ = id => document.getElementById(id);

    // Toggles
    const buttons1 = Array.from(document.querySelectorAll('.toggle-btn1'));
    const output1 = $('output1');
    const hidden1 = $('yesno-value1');

    const buttons2 = Array.from(document.querySelectorAll('.toggle-btn2'));
    const output2 = $('output2');
    const hidden2 = $('yesno-value2');

    const buttons3 = Array.from(document.querySelectorAll('.toggle-btn3'));
    const output3 = $('output3');
    const hidden3 = $('yesno-value3');

    const divitem1 = $('sell');
    const divitem2 = $('equip');
    const divplayer = $('hide3');
    const divmount = $('hide4');

    function setActiveGroup(buttons, hiddenInput, outputEl, value, onChange) {
      buttons.forEach(btn => btn.setAttribute('aria-pressed', btn.dataset.value === value ? 'true' : 'false'));
      hiddenInput.value = value;
      if (outputEl) outputEl.textContent = 'Selected: ' + (value.charAt(0).toUpperCase() + value.slice(1));
      if (typeof onChange === 'function') onChange(value);
    }

    function setActive1(v){ setActiveGroup(buttons1, hidden1, output1, v); }
    function setActive2(v){ setActiveGroup(buttons2, hidden2, output2, v); }
    function setActive3(v){
      setActiveGroup(buttons3, hidden3, output3, v, (val) => {
        const hide = (val === 'yes');
        divplayer.classList.toggle('hidden', hide);
        divmount.classList.toggle('hidden', hide);
      });
    }

    function wireButtons(buttons, setActiveFn){
      buttons.forEach(btn => {
        btn.addEventListener('click', () => setActiveFn(btn.dataset.value));
        btn.addEventListener('keydown', e => {
          if (e.key === ' ' || e.key === 'Spacebar' || e.key === 'Enter') { e.preventDefault(); setActiveFn(btn.dataset.value); return; }
          if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
            e.preventDefault();
            const idx = buttons.indexOf(btn);
            const next = e.key === 'ArrowRight' ? (idx + 1) % buttons.length : (idx - 1 + buttons.length) % buttons.length;
            buttons[next].focus();
          }
        });
      });
    }

    wireButtons(buttons1, setActive1);
    wireButtons(buttons2, setActive2);
    wireButtons(buttons3, setActive3);

    // Initialize toggle state from markup
    const init1 = buttons1.find(b => b.getAttribute('aria-pressed') === 'true') || buttons1[0];
    const init2 = buttons2.find(b => b.getAttribute('aria-pressed') === 'true') || buttons2[0];
    const init3 = buttons3.find(b => b.getAttribute('aria-pressed') === 'true') || buttons3[0];
    if (init1) setActive1(init1.dataset.value);
    if (init2) setActive2(init2.dataset.value);
    if (init3) setActive3(init3.dataset.value);

    // Data helpers
    function parseInputValue(id) {
      const el = $(id);
      if (!el) return 0;
      const v = parseFloat(el.value);
      return Number.isFinite(v) ? v : 0;
    }

    function getStats(prefix) {
      // returns fields normalized as decimals where appropriate
      const damage = parseInputValue(prefix + '_damage');
      const health = parseInputValue(prefix + '_health');
      const dmult = parseInputValue(prefix + '_dmult') / 100;
      const hmult = parseInputValue(prefix + '_hmult') / 100;
      const speed = parseInputValue(prefix + '_speed') / 100;
      const dbl = parseInputValue(prefix + '_double') / 100;
      const crit = parseInputValue(prefix + '_crit') / 100;
      const critdmg = (parseInputValue(prefix + '_critdmg') / 100) + 0.2; // base crit damage +20%
      const lifesteal = parseInputValue(prefix + '_lifesteal') / 100;
      const range = parseInputValue(prefix + '_range') / 100;
      const regen = parseInputValue(prefix + '_regen') / 100;
      const block = parseInputValue(prefix + '_block') / 100;
      const skill = parseInputValue(prefix + '_skill') / 100;
      const cooldown = parseInputValue(prefix + '_cooldown') / 100;

      return { damage, health, dmult, hmult, speed, double: dbl, crit, critdmg, lifesteal, range, regen, block, skill, cooldown };
    }

    // Core formulas
    function computeDPS(p) {
      // defensive: ensure numeric values (p fields are expected to be normalized decimals where appropriate)
      const dmg = Number(p.damage) || 0;
      let dbl = Number(p.double) || 0;
      let crit = Number(p.crit) || 0;
      const critdmg = Number(p.critdmg) || 0;
      let spd = Number(p.speed) || 0;

      dbl = Math.max(0, Math.min(1, dbl));
      dbl = 1 + dbl;

      crit = Math.max(0, Math.min(1, crit));
      crit = 1 + (crit * critdmg);

      const denom = Math.round(15 / (1 + spd));
      spd = (denom <= 0) ? 0 : 10 / denom;

      return dmg * dbl * crit * spd;
    }

    function computeDPS2(i1, i2, player, mount) {
      // Estimate build DPS after swapping item i1 -> i2.
      // All inputs should be "stat objects" with numeric fields (damage, dmult, speed, double, crit, critdmg, etc).
      // This function is intentionally conservative and defensive.
      try {
        // normalize numeric inputs (fall back to 0)
        const pDamage = Number(player.damage) || 0;
        const pDmult = Number(player.dmult) || 0;
        const pSpeed = Number(player.speed) || 0;
        const pDouble = Number(player.double) || 0;
        const pCrit = Number(player.crit) || 0;
        const pCritDmg = Number(player.critdmg) || 0;

        const mDamage = Number(mount.damage / 100) || 0;
        const mDmult = Number(mount.dmult) || 0;

        const i1Damage = Number(i1.damage) || 0;
        const i1Dmult = Number(i1.dmult) || 0;
        const i1Speed = Number(i1.speed) || 0;
        const i1Double = Number(i1.double) || 0;
        const i1Crit = Number(i1.crit) || 0;
        const i1CritDmg = Number(i1.critdmg) || 0;

        const i2Damage = Number(i2.damage) || 0;
        const i2Dmult = Number(i2.dmult) || 0;
        const i2Speed = Number(i2.speed) || 0;
        const i2Double = Number(i2.double) || 0;
        const i2Crit = Number(i2.crit) || 0;
        const i2CritDmg = Number(i2.critdmg) || 0;

        // Build baseline combined raw damage (player + mount), then swap item contribution
        const baseRawDamage = pDamage / (1 + pDmult + mDamage + mDmult);
        const swappedRawDamage = baseRawDamage - i1Damage + i2Damage;

        // Build total damage multiplier (sum of multipliers from player, mount and item differences)
        // Note: dmult fields are expected to be decimals (e.g. 0.25 for +25%).
        const totalMult = 1 + pDmult + mDamage + mDmult - i1Dmult + i2Dmult;

        const finalDamage = swappedRawDamage * totalMult;

        // Combined secondary stats after swap (player + item differences)
        let finalDouble = pDouble - i1Double + i2Double;
        finalDouble = Math.max(0, Math.min(1, finalDouble));
        finalDouble = 1 + finalDouble;
        let finalCrit = pCrit - i1Crit + i2Crit;
        finalCrit = Math.max(0, Math.min(1, finalCrit));
        const finalCritDmg = pCritDmg - i1CritDmg + i2CritDmg;
        finalCrit = 1 + (finalCrit * finalCritDmg);
        let finalSpeed = pSpeed - i1Speed + i2Speed;
        const denom = Math.floor(17 / (1 + finalSpeed));
        finalSpeed = (denom <= 0) ? 0 : 10 / denom;

        const dps = finalDamage * finalDouble * finalCrit * finalSpeed;

        return Number.isFinite(dps) ? dps : 0;
      } catch (err) {
        return 0;
      }
    }

    function computeSustain(p, dps) {
      const ls = Number(p.lifesteal) || 0;
      const regen = Number(p.regen) || 0;
      const hp = Number(p.health) || 0;
      const d = Number(dps) || 0;
      return d * ls + hp * regen;
    }

    function computeSustain2(i1, i2, p, m, dps) {
      // estimate sustain difference after swap; keep defensive
      const d = Number(dps) || 0;
      const lsDiff = (Number(p.lifesteal) || 0) - (Number(i1.lifesteal) || 0) + (Number(i2.lifesteal) || 0);
      const regenDiff = (Number(p.regen) || 0) - (Number(i1.regen) || 0) + (Number(i2.regen) || 0);

      // Build baseline combined raw health (player + mount), then swap item contribution
      const baseRawHealth = (Number(p.health) || 0) / (1 + (Number(p.hmult) || 0) + (Number(m.health) || 0) + (Number(m.hmult) || 0));
      const swappedRawHealth = baseRawHealth - (Number(i1.health) || 0) + (Number(i2.health) || 0);

      // Build total health multiplier (sum of multipliers from player, mount and item differences)
      // Note: hmult fields are expected to be decimals (e.g. 0.25 for +25%).
      const totalHMult = 1 + (Number(p.hmult) || 0) + (Number(m.health) || 0) + (Number(m.hmult) || 0) - (Number(i1.hmult) || 0) + (Number(i2.hmult) || 0);

      const finalHealth = swappedRawHealth * totalHMult;
      return d * lsDiff + finalHealth * regenDiff;
    }

    // Quality calculators (weights can be tuned)
    function computeQA(p) {
      return (p.dmult/0.15) + (p.hmult/0.15) + (p.speed/0.4) + (p.double/0.4) + (p.crit/0.12) + ((p.critdmg - 0.2)/1) + (p.lifesteal/0.2) + (p.range/0.15) + (p.regen/0.06) + (p.block/0.05) + (p.skill/0.3) + (p.cooldown/0.07);
    }
    function computePQA(p) {
      return (p.dmult/0.1) + (p.hmult/0.1) + (p.speed/0.2) + (p.double/0.2) + (p.crit/0.24) + ((p.critdmg - 0.2)/2) + (p.lifesteal/0.1) + (p.range/0.15) + (p.regen/0.04) + (p.block/0.05) + (p.skill/0.6) + (p.cooldown/0.14);
    }
    function compute2QA(p) {
      return (p.dmult/0.3) + (p.hmult/0.3) + (p.speed/0.2) + (p.double/0.2) + (p.crit/0.06) + ((p.critdmg - 0.2)/0.5) + (p.lifesteal/0.1) + (p.range/0.15) + (p.regen/0.06) + (p.block/0.05) + (p.skill/0.6) + (p.cooldown/0.14);
    }

    function simulate() {
      // read inputs
      const item1 = getStats('e1');
      const item2 = getStats('e2');
      const player = getStats('e3');
      const mount = getStats('e4');

      // toggles
      const itemsOnly = hidden3 && hidden3.value === 'yes';
      const doubleSubstats = hidden2 && hidden2.value === 'yes';
      const preferred = hidden1 && hidden1.value === 'yes';

      // choose QA function
      let calcQA = computeQA;
      if (preferred) calcQA = doubleSubstats ? compute2QA : computePQA;

      // compute qualities
      const iqa1 = calcQA(item1);
      const iqa2 = calcQA(item2);
      const pqa = calcQA(player);
      const sqa1 = computeQA(item1);
      const sqa2 = computeQA(item2);
      const sqa = computeQA(player);

      // build result text
      let resultText = '';
      resultText += `Item 1 Quality: ${iqa1.toFixed(2)}\n`;
      resultText += `Item 2 Quality: ${iqa2.toFixed(2)}\n\n`;

      // prepare variables for build-level comparison
      let keepBuildDPS = 0, swapBuildDPS = 0, keepBuildSustain = 0, swapBuildSustain = 0;

      if (!itemsOnly) {
        resultText += `Build Quality: ${pqa.toFixed(2)}\n\n`;

        // baseline build DPS = player + mount contributions
        const playerDps = computeDPS(player);
        keepBuildDPS = (Number.isFinite(playerDps) ? playerDps : 0);

        // estimate swapped build DPS (swap item1 -> item2)
        swapBuildDPS = computeDPS2(item1, item2, player, mount);
        if (!Number.isFinite(swapBuildDPS)) swapBuildDPS = 0;

        resultText += `Build DPS (item 1): ${formatNumber(keepBuildDPS)}\n`;
        resultText += `Build DPS (item 2): ${formatNumber(swapBuildDPS)}\n\n`;

        // sustain uses DPS and entity stats
        keepBuildSustain = computeSustain(player, playerDps);
        if (!Number.isFinite(keepBuildSustain)) keepBuildSustain = 0;

        swapBuildSustain = computeSustain2(item1, item2, player, mount, swapBuildDPS);
        if (!Number.isFinite(swapBuildSustain)) swapBuildSustain = 0;

        resultText += `Build Sustain (item 1): ${formatNumber(keepBuildSustain)}\n`;
        resultText += `Build Sustain (item 2): ${formatNumber(swapBuildSustain)}\n\n`;
      } else {
        // items-only branch left intentionally minimal
      }

      resultText += `Double substats: ${doubleSubstats ? 'Yes' : 'No'}\n`;
      resultText += `Preferred substats focus: ${preferred ? 'Yes' : 'No'}\n\n`;

      // scoring: combine DPS, sustain and quality (you can adjust weights)
      let score1 = iqa1; // default when itemsOnly
      let score2 = iqa2;
      let rate1 = sqa1;
      let rate2 = sqa2;
      let rate3 = sqa;

      if (!itemsOnly) {
        score1 = keepBuildDPS + keepBuildSustain;
        score2 = swapBuildDPS + swapBuildSustain;
        resultText += `Build 1 score: ${formatNumber(score1)} \n`;
        resultText += `Build 2 score: ${formatNumber(score2)} \n\n`;
        rate1 = rate1 * 100 / 12;
        rate2 = rate2 * 100 / 12;
      } else {
        rate1 = rate1 * 100;
        rate2 = rate2 * 100;
      }
      rate3 = rate3 * 100 / 12;
      if (doubleSubstats) {
        rate1 = rate1 / 2;
        rate2 = rate2 / 2;
        rate3 = rate3 / 2;
      }

      if (preferred) {
        if (itemsOnly) {
          resultText += `Item 1 substats: ${formatNumber(rate1)} % \n`;
          resultText += `Item 2 substats: ${formatNumber(rate2)} % \n\n`;
        } else {
          resultText += `Build substats: ${formatNumber(rate3)} % \n\n`;
        }
      }

      divitem1.classList.remove('better','worse');
      divitem2.classList.remove('better','worse');

      if (score1 > score2) {
        resultText += 'Recommendation: Keep Item 1 (higher combined score).\n';
        divitem1.classList.add('better');
        divitem2.classList.add('worse');
      } else if (score2 > score1) {
        resultText += 'Recommendation: Keep Item 2 (higher combined score).\n';
        divitem2.classList.add('better');
        divitem1.classList.add('worse');
      } else {
        resultText += 'Recommendation: Both items are roughly equal.\n';
        if (itemsOnly) {
          const item1Level = (Number(item1.damage) || 0) + (Number(item1.health) || 0);
          const item2Level = (Number(item2.damage) || 0) + (Number(item2.health) || 0);
          if (item1Level > item2Level) {
            resultText += 'Item 1 has a higher level.\n';
          } else if (item2Level > item1Level) {
            resultText += 'Item 2 has a higher level.\n';
          } else {
            resultText += 'Even their levels are the same!\n';
          }
        }
      }

      resultText += '\n';
      resultText += (itemsOnly ? 'Since items only we ignore player and mount.\n' : 'Using player and mount for overall build.\n');
      resultText += (doubleSubstats ? 'Assuming double substats.\n' : 'Assuming single substats.\n');
      resultText += (preferred ? 'Focused on preferred substats.\n' : 'Looking at overall stats.\n');

      // small stats panels
      // $('e3_stats').textContent = `Player Quality ${pqa.toFixed(3)}`;

      $('result').textContent = resultText;
    }

    // Utility functions
    function formatNumber(num) {
      const n = Number(num);
      if (!isFinite(n)) return '0.00';
      const abs = Math.abs(n);
      if (abs >= 1_000_000) return (n/1_000_000).toFixed(2) + 'M';
      if (abs >= 1_000) return (n/1_000).toFixed(2) + 'K';
      return n.toFixed(2);
    }

    function downloadSample() {
      const url = 'https://raw.githubusercontent.com/victorygale/fm_tools/main/data-which.json';
      window.open(url, '_blank');
    }

    // JSON load / fill
    function loadJson(input) {
      const file = input.files && input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          fillPlayerInputs('e1', data.itemOld || {});
          fillPlayerInputs('e2', data.itemNew || {});
          fillPlayerInputs('e3', data.player || {});
          fillPlayerInputs('e4', data.mount || {});
          if (data.options) {
            if (typeof data.options.preferredSubstats !== 'undefined') setActive1(String(data.options.preferredSubstats));
            if (typeof data.options.doubleSubstats !== 'undefined') setActive2(String(data.options.doubleSubstats));
            if (typeof data.options.itemsOnly !== 'undefined') setActive3(String(data.options.itemsOnly));
          }
          simulate();
        } catch (err) {
          alert('Invalid JSON file format.');
        }
      };
      reader.readAsText(file);
    }

    function fillPlayerInputs(prefix, stats) {
      const keys = ['damage','health','dmult','hmult','speed','double','crit','critdmg','lifesteal','range','regen','block','skill','cooldown'];
      keys.forEach(k => {
        if (typeof stats[k] !== 'undefined' && stats[k] !== null) {
          const el = $(prefix + '_' + k);
          if (el) el.value = stats[k];
        }
      });
    }

    function instruct() {
      let instructText = '';
	if ($('instructions').textContent === 'Instructions will appear here.') {
          instructText += `1. Preferred substats assumes the default speed, double and life steal build.\n`;
          instructText += ` - This is +100% for speed, double and life, +50% for damage, health and regeneration and -50% for crit and skill related substats.\n`;
          instructText += `2. Double substats will adjust quality rating and add crit substats to build preference.\n`;
          instructText += ` - This is +100% for crit as well, and -50% for damage, health and skill related substats.\n`;
          instructText += `3. Items only will just compare the quality of 2 items instead of a full build score which is DPS + heals.`;
        } else {
          instructText = 'Instructions will appear here.';
        }
      $('instructions').textContent = instructText;
    }

    function changelog() {
      let changelogText = '';
	if ($('changelogs').textContent === 'Changelogs will appear here.') {
          changelogText += `Updated speed calculations and added disclaimer.\n`;
          changelogText += `Changed the colours.\n`;
          changelogText += `Updated attack speed calculation and added table.\n`;
          changelogText += `Added instructions and changelogs.\n`;
          changelogText += `Updated DPS with attack speed step function.\n`;
          changelogText += `Added skill damage and cooldown for item substat quality.\n`;
          changelogText += `Adjusted preferred substat weightings.\n`;
        } else {
          changelogText = 'Changelogs will appear here.';
        }
      $('changelogs').textContent = changelogText;
    }

    function attackspeed() {
      let attackspeedText = '';
	if ($('attackspeeds').textContent === 'Attack speed summary will appear here.') {
          attackspeedText += `Attack Speed || Time (s)\n`;
          attackspeedText += `===================\n`;
          attackspeedText += `     <7.1%       ||   1.7\n`;
          attackspeedText += `     <15.4%     ||   1.6\n`;
          attackspeedText += `     <25.0%     ||   1.5\n`;
          attackspeedText += `     <36.4%     ||   1.4\n`;
          attackspeedText += `     <50.0%     ||   1.3\n`;
          attackspeedText += `     <66.7%     ||   1.2\n`;
          attackspeedText += `     <87.5%     ||   1.1\n`;
          attackspeedText += `     <114%     ||   1.0\n`;
          attackspeedText += `     <150%     ||   0.9\n`;
          attackspeedText += `     <200%     ||   0.8\n`;
          attackspeedText += `     <275%     ||   0.7\n`;
          attackspeedText += `     <400%     ||   0.6\n`;
          attackspeedText += `     >400%     ||   0.5\n`;
          attackspeedText += `Please note different weapons have different offsets and rounding so the example can only be used as a rough guide.\n`;
        } else {
          attackspeedText = 'Attack speed summary will appear here.';
        }
      $('attackspeeds').textContent = attackspeedText;
    }

  </script>
</body>
</html>